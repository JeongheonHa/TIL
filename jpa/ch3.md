# 영속성 관리

## 1. 영속성 컨텍스트
- `영속성 컨텍스트` : 엔티티를 보관하고 관리하는 공간

### 1.1 영속성 컨텍스트 구조
<img  src="https://user-images.githubusercontent.com/108064146/231303440-f11e78e9-f197-486e-8319-141855706db6.png">

### 1.2 엔티티의 생명주기
- `비영속` : 영속성 컨텍스트와 관련없는 상태
- `영속` : 영속성 컨텍스트에 저장된 상태 
- `준영속` : 영속성 컨텍스트에 저장되었다가 분리된 상태
- `삭제` : 삭제된 상태

### 1.3 영속성 컨텍스트의 특징
- 영속성 컨텍스트는 엔티티를 식별자 값으로 구분한다.
- 영속성 컨텍스트에 저장된 엔티티는 `flush()`가 호출될 때 DB에 반영한다.
- J2SE 환경에서는 EntityManager 1개 당 PersistenceContext 1개가 생성된다.
- J2EE 환경에서는 EntityManager n개가 PersistenceContext 1개를 공유한다.

### 1.4 영속성 컨텍스트가 엔티티를 관리함으로써 얻는 장점
- 1차 캐시
- 동일성 보장
- 트랜잭션을 지원하는 쓰기 지연
- 변경 감지 (dirty checking)
- 지연 로딩

## 2. 등록, 수정, 삭제, 조회

### 2.1 등록

#### 과정
- 영속성 컨텍스트 내부의 1차 캐시에 식별자로 구분하여 해당 엔티티를 저장하고 쓰기지연 SQL 저장소에 Insert 쿼리를 저장
- `flush()` 호출
- 쓰기지연 SQL 저장소에 모아둔 쿼리를 DB에 전달

```java
Member member = new Member();
member.setId("member1");
member.setUsername("이수근");

em.persist(member);
```
### 2.2 조회
- 영속 엔티티의 동일성 보장 (`em.find()`로 같은 엔티티를 반복해서 조회할 경우 1차 캐시에 있는 동일한 엔티티가 반환)
#### 과정
- 1차 캐시에 해당 식별자 값으로 엔티티를 조회
- 1차 캐시에 없으면 DB에 해당 식별자 값으로 데이터를 조회해서 엔티티를 생성
- 1차 캐시에 해당 엔티티를 저장한 후 영속 상태의 엔티티 반환

```java
Member member = em.find(Member.class, "member1"); // find(엔티티 클래스 타입, 식별자 값)
```

### 2.3 수정
- 변경 감지는 영속 상태의 엔티티만 적용 가능
- JPA의 기본 수정 전략은 엔티티의 모든 필드를 업데이트하는 것이다.
    + 애플리케이션 로딩 시점에 수정 쿼리를 미리 생성해두고 재사용 가능
    + DB에 동일한 쿼리를 보낼 경우 이전에 파싱된 쿼리 재사용 가능
#### 과정
- 영속성 컨텍스트에 엔티티 저장시 최초 상태를 복사한 `스냅샷`을 같이 저장
- 영속 상태의 엔티티를 수정
- `flush()` 호출
- 1차 캐시에서 엔티티와 스냅샷을 비교하여 변경되었는지 확인 (dirty checking)
- 변경된 엔티티에 맞게 Update 쿼리를 생성 후 쓰기지연 SQL 저장소에 저장
- 쓰기지연 SQL 저장소에 모아둔 쿼리를 DB에 전달

```java
Member member = em.find(Member.class, "member1");

member.setUsername("김병만");
```

### 2.4 삭제

#### 과정
- 1차 캐시에서 해당 엔티티를 제거
- 쓰기지연 SQL 저장소에 Delete 쿼리 저장
- flush() 호출
- 쓰기지연 SQL 저장소에 모아둔 쿼리를 DB에 전달

```java
Member member = em.find(Member.class, "member1");

em.remove(member);
```

## 3. 플러시
`flush()` : 영속성 컨텍스트의 변경 내용을 DB에 반영한다.

### 3.1 플러시 과정
- 변경 감지
- 쓰기지연 SQL 저장소에 모아둔 쿼리를 DB에 전달

### 3.2 플러시 호출 방법
- `em.flush()`로 직접 호출
- `트랜잭션 커밋`시 자동 호출
- `JPQL` 쿼리 실행시 자동 호출

### 3.3 플러시 모드 옵션
- `FlushModeType.AUTO`: 커밋이나 쿼리를 실행할 때 플러시 (기본값)
- `FlushModeType.COMMIT`: 커밋할 때만 플러시

## 4. 준영속

### 4.1 영속 상태 엔티티를 준영속 상태로 만드는 방법
- `em.detach(entity)`: 특정 엔티티만 준영속 상태로 전환 (in. 1차 캐시 + 쓰기지연 SQL 저장소)
- `em.clear()`: 영속성 컨텍스트를 초기화
- `em.close()`: 영속성 컨텍스트를 종료

### 4.2 준영속 상태의 특징
- 영속성 컨텍스트가 관리하지 않는다.
- 식별자 값을 갖고 있다.
- 지연 로딩을 할 수 없다.

### 4.3 병합
- `em.merge(entity)`: 준영속 상태의 엔티티를 다시 새로운 영속 상태의 엔티티로 반환

```java
Member mergeMember = em.merge(member);
```

## Reference
> 자바 ORM 표준 JPA 프로그래밍 [김영한]
